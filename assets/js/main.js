function V2d(t,e){this.x=t,this.y=e}V2d.prototype.add=function(t){return new V2d(this.x+t.x,this.y+t.y)},V2d.prototype.sub=function(t){return new V2d(this.x-t.x,this.y-t.y)},V2d.prototype.mul=function(t){return new V2d(this.x*t,this.y*t)},V2d.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},V2d.prototype.angle=function(){return Math.atan2(this.x,this.y)},V2d.prototype.rotate=function(t){return new V2d(Math.cos(t)*this.x-Math.sin(t)*this.y,Math.sin(t)*this.x+Math.cos(t)*this.y)};const fullcircle=180*Math.PI;function Scene(t){this.ctx=t,this.viewpoint=new V2d(0,0),this.viewz=1,this.viewscale=1200,this.distscale=2,this.circles=[]}function terrain(t){return 10*Math.sin(t/1e3)+5*Math.cos(t/527)+2*Math.sin(t/219)}function bend(t){return 200*Math.sin(t/909)+51*Math.cos(t/517)+23*Math.sin(t/201)}function Car(){this.pos=new V2d(0,1),this.vel=new V2d(0,.005),this.braking=!1,this.mainbeam=!1,this.leftindicator=!1,this.rightindicator=!1,this.indicatorperiod=.9+.2*Math.random(),this.indication=0,this.lanes=[0],this.lane=0;var t=.2*Math.random()+.4,e=.3*Math.random()+1.3,i=.05*Math.random()+.1,s=colour(180,255,0,50,0,50),s=(this.rearlights=[{xy:new V2d(-e/2,0),z:t,r:i,col:s},{xy:new V2d(e/2,0),z:t,r:i,col:s}],colour(180,255,180,255,180,255)),s=(this.headlights=[{xy:new V2d(-e/2,0),z:t,r:i,col:s},{xy:new V2d(e/2,0),z:t,r:i,col:s}],colour(180,255,100,200,0,100)),e=.2+e+.1*Math.random(),t=t-.1+.2*Math.random(),i=i-(.04+.03*Math.random());this.leftindicatorlights=[{xy:new V2d(-e/2,0),z:t,r:i,col:s}],this.rightindicatorlights=[{xy:new V2d(e/2,0),z:t,r:i,col:s}]}function colour(t,e,i,s,n,a){return`rgb(${t+Math.random()*(e-t)},${i+Math.random()*(s-i)},${n+Math.random()*(a-n)})`}function Plane(){this.pos=new V2d(0,0),this.vel=new V2d(25,15),this.z=3e3,this.t=0,this.period=1.2+.2*Math.random()}Scene.prototype.drawCircle=function(t,e,i,s,n){e=this.project(t,e,i);e&&(e.col=s,e.roady=t.y,i=this.project(t,0,0),e.yground=i.y,n&&n.no_occlude&&(e.no_occlude=!0),this.circles.push(e))},Scene.prototype.render=function(){this.ctx.globalCompositeOperation="lighter",this.ctx.globalAlpha=.2,this.circles.sort((t,e)=>t.roady-e.roady);let t=this.ctx.canvas.height;for(circle of this.circles)circle.yground<t&&(t=circle.yground),circle.y>t&&!circle.no_occlude&&(circle.occluded=!0);for(circle of this.circles)if(!circle.occluded){this.ctx.fillStyle=circle.col;for(let t=1;0<t;t-=.15)this.ctx.beginPath(),this.ctx.arc(circle.x,circle.y,1.5*circle.r*t*t,0,fullcircle),this.ctx.fill()}this.ctx.globalCompositeOperation="source-over",this.ctx.globalAlpha=1},Scene.prototype.project=function(t,e,i){var s,n=bend(this.viewpoint.y+.1)-bend(this.viewpoint.y),n=Math.atan2(n,.1),n=t.add(new V2d(bend(t.y),0)).sub(this.viewpoint.add(new V2d(bend(this.viewpoint.y),0))).rotate(n),t=(e+=terrain(t.y))-(this.viewz+terrain(this.viewpoint.y));return n.y<=0||(e=this.distscale*Math.sqrt(n.y*n.y+t*t))<.5?null:(s=this.viewscale*this.ctx.canvas.width/640,{x:this.ctx.canvas.width/2+s*(n.x/e),y:this.ctx.canvas.height/2-t/e*s,r:i/e*s})},Car.prototype.render=function(t){0<this.vel.y?this.drawLights(t,this.rearlights):this.drawLights(t,this.headlights),this.leftindicator&&this.indication>this.indicatorperiod/2&&this.drawLights(t,this.leftindicatorlights),this.rightindicator&&this.indication>this.indicatorperiod/2&&this.drawLights(t,this.rightindicatorlights)},Car.prototype.drawLights=function(t,e){for(l of e)t.drawCircle(this.pos.add(l.xy),l.z,l.r,l.col)},Car.prototype.step=function(t){for(this.pos=this.pos.add(this.vel.mul(t)),this.indication+=t;this.indication>this.indicatorperiod;)this.indication-=this.indicatorperiod;for(var e=2500;this.pos.y>observer.pos.y+e&&this.vel.y>observer.vel.y;)this.pos.y-=e;for(;this.pos.y<observer.pos.y&&this.vel.y<observer.vel.y;)this.pos.y+=e;let i=0;for(let t=0;t<this.lanes.length;t++)Math.abs(this.pos.x-this.lanes[t])<Math.abs(this.pos.x-this.lanes[i])&&(i=t);this.lane=i;var s,n=Math.sign(this.vel.y);this.changelane&&(s=this.targetlane-this.sourcelane,this.lane==this.targetlane?this.vel=new V2d(this.vel.x-n*s*.79*t,this.vel.y):this.vel=new V2d(this.vel.x+n*s*.8*t,this.vel.y),Math.sign(this.pos.x-this.lanes[this.targetlane])!=Math.sign(this.pos.x+4*this.vel.x*t-this.lanes[this.targetlane])&&(this.lane=this.targetlane,this.pos=new V2d(this.lanes[this.lane],this.pos.y),this.vel=new V2d(0,this.vel.y),this.changelane=!1));let a=0<this.lane;t:for(let t=0;t<cars.length;t++){var h=cars[t];if(h!=this&&-1!=Math.sign(h.vel.y*this.vel.y))for(let t=-1;t<=1;t++){var r=t*e;if(Math.sign(h.vel.y)==n&&this.lane<this.lanes.length-1&&this.lane<=h.lane&&n*(this.pos.y+r)<n*h.pos.y&&n*this.vel.y>n*h.vel.y&&n*(this.pos.y+r+7*this.vel.y+2)>n*(h.pos.y+7*h.vel.y)){this.changelane=!0,this.sourcelane=this.lane,this.targetlane=this.lane+1;break t}Math.sign(h.vel.y)==n&&h.lane==this.lane-1&&n*(this.pos.y+r)<n*h.pos.y&&n*this.vel.y>n*h.vel.y&&n*(this.pos.y+r+7*this.vel.y*3)>n*(h.pos.y+7*h.vel.y*3+2)&&(a=!1)}}!this.changelane&&a&&(this.changelane=!0,this.sourcelane=this.lane,this.targetlane=this.lane-1),this.changelane?(this.rightindicator=this.targetlane>this.sourcelane,this.leftindicator=this.targetlane<this.sourcelane):(this.indication=0,this.leftindicator=!1,this.rightindicator=!1)},Plane.prototype.render=function(t){var e=0<this.vel.x?"#585":"#855";this.t>this.period/2&&t.drawCircle(this.pos,this.z,12,e)},Plane.prototype.step=function(t){for(this.pos=this.pos.add(this.vel.mul(t)),this.t+=t;this.t>this.period;)this.t-=this.period};let laststep=null,observer,cars=[],planes=[],lastwidth,lastheight;const lanes=[-10,-7,-4],speed=[60,66,80],catseyedist=20,streetlightdist=107,started=Date.now();function init(){(observer=new Car).pos.x=lanes[1],observer.vel.y=1600*speed[1]/3600;var e=observer.lanes=lanes,i=e.map(t=>-t);for(let t=0;t<100;t++){var s=new Car,n=Math.floor(Math.random()*lanes.length),n=(s.pos=new V2d(lanes[n],25*t),speed[n]);s.vel=new V2d(0,1600*n/3600),s.lanes=e,Math.random()<.5&&(s.vel.y=-s.vel.y,s.pos.x=-s.pos.x,s.lanes=i),s.vel.y+=20*Math.random()-10,cars.push(s)}cars.push(observer),resize(document.getElementById("canvas")),render()}function render(){step();var t=document.getElementById("canvas"),e=(t.clientWidth==lastwidth&&t.clientHeight==lastheight||resize(t),t.getContext("2d")),i=(e.fillStyle="rgba(1,1,1,0.3)",e.fillRect(0,0,t.width,t.height),new Scene(e));i.viewpoint=observer.pos,i.viewz=1,catseyes(i,lanes[0]-1.5,"#811"),catseyes(i,lanes[0]+1.5,"#666"),catseyes(i,lanes[1]+1.5,"#666"),catseyes(i,lanes[2]+1.5,"#861"),streetlights(i,lanes[0]-3.5),streetlights(i,-.5),streetlights(i,-(lanes[0]-3.5)),streetlights(i,.5);for(car of cars)car.render(i);for(plane of planes)plane.render(i);i.render(),window.requestAnimationFrame(render)}function catseyes(e,i,s){for(let t=(Math.floor(observer.pos.y/catseyedist)-1)*catseyedist;t<observer.pos.y+100;t+=catseyedist)e.drawCircle(new V2d(i-.02,t),.01,.015,s,{no_occlude:!0}),e.drawCircle(new V2d(i+.02,t),.01,.015,s,{no_occlude:!0})}function streetlights(e,i){for(let t=(Math.floor(observer.pos.y/streetlightdist)-1)*streetlightdist;t<observer.pos.y+3e3;t+=streetlightdist){var s=`rgb(255,255,${150+(99*i+31*t)%101})`;e.drawCircle(new V2d(i,t),5,.2,s)}}function step(){var t=Date.now();if(laststep){var e,i=(t-laststep)/1e3;laststep=t;for(car of cars)car.step(i);for(plane of planes)plane.step(i);planes=planes.filter(t=>t.pos.y>observer.pos.y),Math.random()<5e-5&&planes.length<4&&((e=new Plane).pos=new V2d(observer.pos.x-1e4-2e3*Math.random(),observer.pos.y+2e4+5e3*Math.random()),e.vel=new V2d(30+20*Math.random(),10*Math.random()-5),Math.random()<.5&&(e.pos=new V2d(-e.pos.x,e.pos.y),e.vel.x=-e.vel.x),e.z=3e3+2e3*Math.random(),planes.push(e))}else laststep=t}function resize(t){lastwidth=t.width=t.clientWidth,lastheight=t.height=t.clientHeight;var e=t.getContext("2d");e.fillStyle="rgb(0,0,0)",e.beginPath(),e.rect(0,0,t.width,t.height),e.fill()}init();let playing=!1;document.getElementById("canvas").onclick=function(){playing?document.getElementById("audio").pause():document.getElementById("audio").play(),playing=!playing};